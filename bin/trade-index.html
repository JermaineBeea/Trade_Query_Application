<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Trade Calculator - Trade_Function</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      padding: 30px;
    }
    .header {
      text-align: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 3px solid #667eea;
    }
    .header h1 {
      margin: 0 0 8px 0;
      font-size: 28px;
      color: #1e293b;
    }
    .header p {
      margin: 4px 0;
      color: #64748b;
      font-size: 14px;
    }
    
    /* Trade Action Toggle */
    .section-label {
      font-weight: 700;
      margin-bottom: 10px;
      display: block;
      color: #1e293b;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .trade-action-toggle {
      display: inline-flex;
      background: #f1f5f9;
      border-radius: 10px;
      padding: 6px;
      gap: 6px;
      border: 2px solid #e2e8f0;
      margin-bottom: 20px;
    }
    .trade-action-btn {
      padding: 10px 30px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: #64748b;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }
    .trade-action-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(102,126,234,0.4);
      transform: translateY(-2px);
    }
    .trade-action-btn:hover:not(.active) {
      background: #e2e8f0;
      color: #475569;
    }
    
    /* Controls */
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    .controls label {
      display: flex;
      flex-direction: column;
      font-weight: 600;
      font-size: 13px;
      color: #475569;
    }
    .controls input {
      padding: 10px 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      margin-top: 6px;
      transition: border-color 0.2s;
    }
    .controls input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    /* Actions */
    .actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin: 20px 0;
      padding: 16px;
      background: #f8fafc;
      border-radius: 10px;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: #667eea;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }
    button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102,126,234,0.3);
    }
    button.green {
      background: #10b981;
    }
    button.green:hover {
      background: #059669;
    }
    button.red {
      background: #ef4444;
    }
    button.red:hover {
      background: #dc2626;
    }
    
    /* Toggle Switch */
    .toggle-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: auto;
    }
    .toggle-container span {
      font-weight: 600;
      color: #475569;
      font-size: 13px;
    }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 56px;
      height: 30px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: #cbd5e1;
      transition: 0.3s;
      border-radius: 30px;
    }
    .slider:before {
      content: "";
      position: absolute;
      height: 24px;
      width: 24px;
      left: 3px;
      top: 3px;
      background: #fff;
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .toggle-switch input:checked + .slider {
      background: #667eea;
    }
    .toggle-switch input:checked + .slider:before {
      transform: translateX(26px);
    }
    
    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      padding: 14px 12px;
      text-align: left;
      font-size: 13px;
    }
    th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 12px;
    }
    td {
      border-bottom: 1px solid #e2e8f0;
    }
    tr:last-child td {
      border-bottom: none;
    }
    tr:nth-child(even) {
      background: #f8fafc;
    }
    td:first-child {
      font-weight: 600;
      color: #1e293b;
      text-transform: capitalize;
    }
    td input {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 13px;
    }
    td input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    /* Status Messages */
    .status {
      margin-top: 16px;
      padding: 12px 16px;
      border-radius: 8px;
      display: none;
      font-weight: 600;
      font-size: 14px;
    }
    .status.success {
      background: #d1fae5;
      color: #065f46;
      border: 2px solid #10b981;
    }
    .status.error {
      background: #fee2e2;
      color: #991b1b;
      border: 2px solid #ef4444;
    }
    
    /* Loading */
    .loading {
      display: none;
      text-align: center;
      margin: 16px 0;
      color: #667eea;
      font-weight: 700;
      font-size: 16px;
    }
    .loading:after {
      content: '...';
      animation: dots 1.5s infinite;
    }
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #64748b;
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîÑ Trade Calculator</h1>
      <p>Multi-commodity Trading Analysis with SELL/BUY Actions</p>
    </div>

    <!-- Trade Action Selection -->
    <div style="margin-bottom: 24px;">
      <span class="section-label">Trade Action</span>
      <div class="trade-action-toggle">
        <button class="trade-action-btn active" data-action="SELL" onclick="setTradeAction('SELL')">
          üìâ SELL
        </button>
        <button class="trade-action-btn" data-action="BUY" onclick="setTradeAction('BUY')">
          üìà BUY
        </button>
      </div>
    </div>

    <!-- Parameter Inputs -->
    <span class="section-label">Parameters</span>
    <div class="controls">
      <label>
        Spread
        <input type="number" id="spread" step="0.01" value="0.01"/>
      </label>
      <label>
        rate BK (Rate of BAse commodity to traded commodity) NB:DEFAULT VALUE USED IMPLICITLY
        <input type="number" id="rateBK" step="0.0001" value="17.7055"/>
      </label>
      <label>
        rate KN (Rate of tRaded commodity to Nominated commodity) NB:DEFAULT VALUE USED IMPLICITLY
        <input type="number" id="rateKN" step="0.0001" value="1.0"/>
      </label>
    </div>

    <!-- Action Buttons -->
    <div class="actions">
      <button onclick="runQuery()">‚ñ∂Ô∏è Run Calculations</button>
      <button onclick="loadExampleDefaults()" class="green">üìã Load Examples</button>
      <button onclick="resetToZero()" class="red">üóëÔ∏è Reset All</button>

      <div class="toggle-container">
        <span>Market Rate Mode</span>
        <label class="toggle-switch">
          <input type="checkbox" id="basedOnMarketRate"/>
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <div class="loading" id="loading">Processing</div>

    <!-- Data Table -->
    <table id="dataTableContainer">
      <thead>
        <tr>
          <th>Variable</th>
          <th>Minimum</th>
          <th>Maximum</th>
          <th>Return Min</th>
          <th>Return Max</th>
        </tr>
      </thead>
      <tbody id="dataTable">
        <tr>
          <td colspan="5" class="empty-state">
            <div class="empty-state-icon">üìä</div>
            <div>Loading data...</div>
          </td>
        </tr>
      </tbody>
    </table>

    <div id="status" class="status"></div>
  </div>

  <script>
    const APP_DEFAULTS = {
        tradeAction: 'SELL',
        spread: 0.01,
        rateBK: 17.7055,
        rateKN: 1.0,
        basedOnMarketRate: false
    };

    const EXAMPLE_VALUES = {
        'tradeprofit': { min: -88.0, max: -88.0 },
        'profitfactor': { min: -0.000497, max: -0.000497 },
        'tradeamount': { min: 10000.00, max: 10000.00 },
        'openingvalue': { min: 17.6967, max: 17.6967 },
        'closingvalue': { min: 17.7055, max: 17.7055 }
    };

    let currentData = [];
    let currentTradeAction = APP_DEFAULTS.tradeAction;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Page loaded, initializing...');
      loadData();
    });

    function setTradeAction(action) {
      currentTradeAction = action;
      document.querySelectorAll('.trade-action-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.action === action);
      });
      console.log('Trade action set to:', action);
      showStatus(`Trade action changed to ${action}`, 'success');
    }

    async function loadExampleDefaults() {
      if (!confirm('Load example values? This will overwrite current inputs.')) return;
      
      showLoading(true);
      try {
        for (const [variable, values] of Object.entries(EXAMPLE_VALUES)) {
          await updateValue(variable, 'minimum', values.min, true);
          await updateValue(variable, 'maximum', values.max, true);
        }
        await loadData();
        showStatus('‚úÖ Example values loaded successfully!', 'success');
      } catch (error) {
        showStatus('‚ùå Error loading examples: ' + error.message, 'error');
      }
      showLoading(false);
    }

    async function resetToZero() {
      if (!confirm('Reset all values to zero?')) return;
      
      showLoading(true);
      try {
        const response = await fetch('/api/reset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ resetType: 'zero' })
        });
        
        const result = await response.json();
        if (result.success) {
          await loadData();
          showStatus('‚úÖ All values reset to zero', 'success');
        } else {
          showStatus('‚ùå Reset failed: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        showStatus('‚ùå Error: ' + error.message, 'error');
      }
      showLoading(false);
    }

    async function loadData() {
      console.log('Loading data from API...');
      showLoading(true);
      
      try {
        const response = await fetch('/api/data');
        const result = await response.json();
        
        console.log('API Response:', result);
        
        if (result.data && result.data.length > 0) {
          currentData = result.data;
          populateTable(result.data);
          console.log('Data loaded successfully:', result.data.length, 'records');
        } else {
          console.warn('No data returned from API');
          populateTable([]);
        }
      } catch (error) {
        console.error('Error loading data:', error);
        showStatus('‚ùå Failed to load data: ' + error.message, 'error');
        populateTable([]);
      }
      
      showLoading(false);
    }

    function populateTable(data) {
      const tbody = document.getElementById('dataTable');
      tbody.innerHTML = '';
      
      console.log('Populating table with', data.length, 'rows');
      
      if (data.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="empty-state">
              <div class="empty-state-icon">üì≠</div>
              <div>No data available. Click "Load Examples" or "Run Calculations"</div>
            </td>
          </tr>
        `;
        return;
      }
      
      data.forEach(item => {
        console.log('Adding row for:', item.variable);
        const row = document.createElement('tr');
        
        const minValue = item.minimum || '0';
        const maxValue = item.maximum || '0';
        const returnMinValue = parseFloat(item.returnmin || 0).toFixed(6);
        const returnMaxValue = parseFloat(item.returnmax || 0).toFixed(6);
        
        row.innerHTML = `
          <td>${item.variable}</td>
          <td>
            <input type="number" 
                   step="0.000001" 
                   value="${minValue}"
                   onchange="updateValue('${item.variable}', 'minimum', this.value)">
          </td>
          <td>
            <input type="number" 
                   step="0.000001" 
                   value="${maxValue}"
                   onchange="updateValue('${item.variable}', 'maximum', this.value)">
          </td>
          <td>${returnMinValue}</td>
          <td>${returnMaxValue}</td>
        `;
        tbody.appendChild(row);
      });
    }

    async function updateValue(variable, column, value, silent = false) {
      try {
        const response = await fetch('/api/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ variable, column, value: value.toString() })
        });
        
        const result = await response.json();
        
        if (result.success) {
          if (!silent) {
            showStatus(`‚úÖ Updated ${variable}.${column} = ${value}`, 'success');
          }
          console.log(`Updated ${variable}.${column} = ${value}`);
        } else {
          showStatus('‚ùå Update failed: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        showStatus('‚ùå Error: ' + error.message, 'error');
      }
    }

    async function runQuery() {
      showLoading(true);
      
      const params = {
        tradeAction: currentTradeAction,
        spread: parseFloat(document.getElementById('spread').value) || APP_DEFAULTS.spread,
        rateBK: parseFloat(document.getElementById('rateBK').value) || APP_DEFAULTS.rateBK,
        rateKN: parseFloat(document.getElementById('rateKN').value) || APP_DEFAULTS.rateKN,
        basedOnMarketRate: document.getElementById('basedOnMarketRate').checked
      };
      
      console.log('Running query with params:', params);
      
      try {
        const response = await fetch('/api/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(params)
        });
        
        const result = await response.json();
        console.log('Query result:', result);
        
        if (result.success && result.data) {
          currentData = result.data.data;
          populateTable(result.data.data);
          showStatus('‚úÖ ' + (result.message || 'Calculations completed!'), 'success');
        } else {
          showStatus('‚ùå Query failed: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        console.error('Query error:', error);
        showStatus('‚ùå Error: ' + error.message, 'error');
      }
      
      showLoading(false);
    }

    function showStatus(message, type) {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
      statusDiv.style.display = 'block';
      setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
    }

    function showLoading(show) {
      document.getElementById('loading').style.display = show ? 'block' : 'none';
    }
  </script>
</body>
</html>